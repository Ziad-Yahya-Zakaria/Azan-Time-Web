<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>أذان تايم ويب - المطور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --primary: #0a261c; --accent: #b89564; --light: #f4f1e6; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--light); 
            color: #222; 
            margin: 0; 
            overflow: hidden; 
            height: 100dvh; 
        }

        header { 
            background: var(--primary); 
            padding: env(safe-area-inset-top) 20px 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--accent); 
            z-index: 500;
        }

        .page { 
            display: none; 
            height: calc(100dvh - 145px); 
            overflow-y: auto; 
            padding: 15px; 
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; }
        
        /* تنسيقات قارئ المصحف الجديد */
        #page-quran { padding: 0 !important; overflow: hidden; position: relative; background: #2c2c2c; }
        .pdf-viewer-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #pdf-canvas {
            max-width: 100%;
            height: auto;
            margin: auto;
            display: block;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .pdf-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(10, 38, 28, 0.9);
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid var(--accent);
            z-index: 100;
        }
        .pdf-btn { color: white; padding: 5px 10px; font-weight: bold; }
        .index-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        .card { 
            background: white; 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 12px; 
            border-right: 5px solid var(--accent); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .player-bar { 
            position: fixed; 
            bottom: 80px; 
            width: 94%; 
            left: 3%; 
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 20px; 
            padding: 12px 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 400; 
            transition: 0.4s ease; 
        }
        .player-bar.hidden-player { transform: translateY(180%); opacity: 0; }
        
        #toggle-player { 
            position: fixed; 
            bottom: 95px; 
            left: 20px; 
            z-index: 450; 
            background: var(--primary); 
            color: white; 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid var(--accent);
        }

        .progress-bg { width: 100%; height: 6px; background: #eee; border-radius: 10px; margin: 12px 0; cursor: pointer; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 10px; }
        
        nav.tabs { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 75px; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding-bottom: env(safe-area-inset-bottom);
            border-top: 1px solid #eee; 
            z-index: 500; 
        }
        .tab-item { color: #aaa; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .tab-item.active { color: var(--primary); }
        .tab-item b { font-size: 11px; }
        .icon-svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 2px; }
        
        .btn-play { background: var(--primary); color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }

        .radio-card {
            background: white;
            border: 2px solid var(--accent);
            border-radius: 25px;
            padding: 30px 20px;
        }
    </style>
</head>
<body>

<header>
    <div id="dateH" class="text-[var(--accent)] font-bold text-[10px]">جاري التحميل</div>
    <div class="text-white font-black text-lg">أذان تايم ويب</div>
    <div id="azanStatus" class="hidden text-red-500 font-bold text-[10px] animate-pulse">وقت الصلاة</div>
</header>

<div id="toggle-player" onclick="togglePlayerView()">
    <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41-1.41L12 21l4.59-4.59-1.41-1.41L12 18.17z"/></svg>
</div>

<div id="page-quran" class="page active">
    <div class="pdf-viewer-container">
        <div id="loading-pdf" class="absolute inset-0 flex items-center justify-center text-white z-50">جاري تحميل المصحف...</div>
        <canvas id="pdf-canvas"></canvas>
        
        <div class="pdf-controls">
            <button class="pdf-btn" onclick="prevPage()">السابق</button>
            <span id="page-num" class="text-accent text-sm self-center">...</span>
            <button class="pdf-btn" onclick="nextPage()">التالي</button>
            <button class="pdf-btn border-r pr-2 mr-2" onclick="toggleIndex()">الفهرس</button>
        </div>

        <div id="index-modal" class="index-modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold">الفهرس السريع</h3>
                <button onclick="toggleIndex()" class="text-red-500">إغلاق</button>
            </div>
            <div id="index-list" class="grid grid-cols-2 gap-2">
                </div>
        </div>
    </div>
</div>

<div id="page-audio" class="page">
    <div id="reciter-ui"></div>
    <div id="audio-suras-ui" class="hidden">
        <button onclick="closeAudio()" class="mb-4 text-emerald-900 font-bold flex items-center gap-2">
            <svg class="w-5 h-5 fill-current"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg> القراء
        </button>
        <div id="audio-list-ui"></div>
    </div>
</div>

<div id="page-radio" class="page">
    <div class="radio-card text-center mt-10">
        <svg class="w-16 h-16 mx-auto mb-4 fill-emerald-900" viewBox="0 0 24 24"><path d="M20 6H4V4h16v2zm0 10H4v2h16v-2zm0-5H4v2h16v-2zM4 20h16v-2H4v2z"/></svg>
        <h2 class="font-black text-xl text-emerald-900 mb-2">إذاعة القرآن الكريم</h2>
        <p class="text-gray-400 text-sm mb-8">بث مباشر من القاهرة</p>
        <button onclick="playA('https://n0e.radiojar.com/8s5u5tpdtwzuv', 'البث المباشر', 'إذاعة القاهرة')" class="bg-emerald-900 text-white w-full py-4 rounded-xl font-bold">تشغيل الإذاعة</button>
    </div>
</div>

<div id="page-azan" class="page">
    <div class="bg-white p-6 rounded-3xl text-center shadow-sm mb-5">
        <p class="text-gray-400 text-xs">الوقت المتبقي للأذان</p>
        <div id="timer" class="text-4xl font-black text-red-600 my-2">00:00:00</div>
        <div id="nextP" class="font-bold text-emerald-900">--</div>
    </div>
    <div id="p-grid" class="grid grid-cols-2 gap-3 mb-5"></div>
    <div class="bg-white p-5 rounded-3xl text-center shadow-sm">
        <p class="font-bold mb-3 text-xs">اتجاه القبلة</p>
        <div class="w-24 h-24 mx-auto border-4 border-[var(--primary)] rounded-full relative flex items-center justify-center">
            <div id="needle" class="absolute w-1 h-16 bg-red-600 transition-transform"></div>
        </div>
    </div>
</div>

<div id="page-licenses" class="page">
    <div class="bg-white p-5 rounded-2xl shadow-sm border-t-4 border-[var(--accent)]">
        <h2 class="font-black text-lg mb-4 text-[var(--primary)]">التراخيص والحقوق</h2>
        <div class="space-y-4 text-sm text-gray-700 leading-relaxed">
            <p class="border-b pb-2"><strong>المصحف الشريف:</strong> مجمع الملك فهد لطباعة المصحف الشريف.</p>
            <p class="border-b pb-2"><strong>المكتبة الصوتية:</strong> شبكة MP3 Quran العالمية.</p>
            <p class="border-b pb-2"><strong>مواقيت الصلاة:</strong> AlAdhan API للخدمات الجغرافية.</p>
            <p class="border-b pb-2"><strong>إذاعة القرآن:</strong> إذاعة القرآن الكريم من القاهرة (بث مباشر).</p>
            <p class="border-b pb-2"><strong>التقنيات:</strong> Tailwind CSS, AlQuran Cloud API.</p>
        </div>
        <div class="text-center bg-gray-50 p-6 rounded-xl mt-6">
            <p class="text-sm font-bold text-gray-800 mb-1">تطوير: زياد يحيى زكريا أحمد</p>
            <p class="text-[10px] font-bold text-gray-400 tracking-widest uppercase">أذان تايم ويب &copy; 2026</p>
        </div>
    </div>
</div>

<div id="pBar" class="player-bar hidden-player">
    <div class="flex justify-between text-[9px] font-bold text-gray-400 mb-1">
        <span id="cT">00:00</span>
        <span id="pTitle" class="text-emerald-900 truncate px-4 text-center w-full">أذان تايم ويب</span>
        <span id="tT">00:00</span>
    </div>
    <div class="progress-bg" onclick="seek(event)">
        <div id="pFill" class="progress-fill"></div>
    </div>
    <div class="flex justify-around items-center">
        <button onclick="setSpd()" id="spd" class="text-[10px] border px-2 rounded">1.0x</button>
        <button onclick="skip(-10)"><svg class="w-5 h-5 fill-current"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
        <button onclick="toggleP()" id="pBtn" class="btn-play"><svg id="pIcon" class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
        <button onclick="skip(10)"><svg class="w-5 h-5 fill-current" style="transform: rotate(180deg);"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
        <a id="dl" href="#" download class="fill-emerald-900"><svg class="w-5 h-5 fill-current"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></a>
    </div>
</div>

<nav class="tabs">
    <div class="tab-item active" onclick="tab(this, 'page-quran')"><svg class="icon-svg"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg><b>المصحف</b></div>
    <div class="tab-item" onclick="tab(this, 'page-audio')"><svg class="icon-svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><b>القراء</b></div>
    <div class="tab-item" onclick="tab(this, 'page-radio')"><svg class="icon-svg"><path d="M20 6H4V4h16v2zm0 10H4v2h16v-2zm0-5H4v2h16v-2zM4 20h16v-2H4v2z"/></svg><b>الإذاعة</b></div>
    <div class="tab-item" onclick="tab(this, 'page-azan')"><svg class="icon-svg"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><b>الأذان</b></div>
    <div class="tab-item" onclick="tab(this, 'page-licenses')"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg><b>الحقوق</b></div>
</nav>

<audio id="mainP"></audio>
<audio id="azP" src="https://www.islamcan.com/common/azan/azan1.mp3"></audio>

<script>
    // متغيرات قارئ الـ PDF
    let pdfDoc = null,
        pageNum = 1,
        ctx = document.getElementById('pdf-canvas').getContext('2d');

    // رابط ملف الـ PDF (استخدمنا Proxy لتجنب مشاكل الـ CORS)
    const pdfUrl = 'https://raw.githubusercontent.com/Ziad-Yahya-Zakaria/Azan-Time-Web/cf1226493ed0aca0d724676fcdbf6a7ed5a1314c/Noor-Book.com%20%20%D8%A7%D9%84%D9%82%D8%B1%D8%A7%D9%84%D9%86%20%D8%A7%D9%84%D9%83%D8%B1%D9%8A%D9%85.pdf';

    const player = document.getElementById('mainP');
    const azan = document.getElementById('azP');
    let pT = {};
    const recs = [
        { n: "محمود خليل الحصري", s: "https://server8.mp3quran.net/huasry/" },
        { n: "محمد صديق المنشاوي", s: "https://server10.mp3quran.net/minsh/" },
        { n: "عبدالباسط عبدالصمد", s: "https://server7.mp3quran.net/basit/" },
        { n: "مشاري العفاسي", s: "https://server8.mp3quran.net/afs/" }
    ];

    async function init() {
        // تحميل بيانات القراء
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        const suras = data.data;

        document.getElementById('reciter-ui').innerHTML = recs.map(r => `
            <div class="card" onclick="openA('${r.n}', '${r.s}', ${JSON.stringify(suras).replace(/"/g, '&quot;')})">
                <span>${r.n}</span>
                <svg class="w-5 h-5 fill-emerald-900" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
        `).join('');

        // تحميل الفهرس (مثال لبعض السور)
        const sampleIndex = [
            {n: 'الفاتحة', p: 1}, {n: 'البقرة', p: 2}, {n: 'آل عمران', p: 50},
            {n: 'النساء', p: 77}, {n: 'المائدة', p: 106}, {n: 'الكهف', p: 293},
            {n: 'يس', p: 440}, {n: 'جزء عم', p: 582}
        ];
        document.getElementById('index-list').innerHTML = sampleIndex.map(i => `
            <button onclick="goToPage(${i.p})" class="bg-emerald-900/50 text-white p-3 rounded-lg text-sm">${i.n}</button>
        `).join('');

        loadP();
        loadPDF();
    }

    // وظائف قارئ PDF
    async function loadPDF() {
        try {
            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            pdfDoc = await loadingTask.promise;
            document.getElementById('loading-pdf').style.display = 'none';
            renderPage(pageNum);
        } catch (err) {
            document.getElementById('loading-pdf').innerText = 'خطأ في تحميل الملف';
        }
    }

    async function renderPage(num) {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.getElementById('pdf-canvas');
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        document.getElementById('page-num').textContent = `صفحة ${num} من ${pdfDoc.numPages}`;
    }

    function prevPage() { if (pageNum <= 1) return; pageNum--; renderPage(pageNum); }
    function nextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; renderPage(pageNum); }
    function goToPage(p) { pageNum = p; renderPage(p); toggleIndex(); }
    function toggleIndex() { 
        const m = document.getElementById('index-modal');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    // باقي الوظائف الأصلية (لم يتم تغييرها)
    function togglePlayerView() {
        document.getElementById('pBar').classList.toggle('hidden-player');
    }

    function openA(name, srv, suras) {
        document.getElementById('reciter-ui').style.display = 'none';
        document.getElementById('audio-suras-ui').classList.remove('hidden');
        document.getElementById('audio-list-ui').innerHTML = suras.map(s => `
            <div class="card" onclick="playA('${srv}${s.number.toString().padStart(3,'0')}.mp3', '${s.name}', '${name}')">
                <span>${s.name}</span>
                <svg class="w-5 h-5 fill-emerald-900" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
        `).join('');
    }

    function closeAudio() {
        document.getElementById('reciter-ui').style.display = 'block';
        document.getElementById('audio-suras-ui').classList.add('hidden');
    }

    function playA(url, sn, rn) {
        player.src = url;
        document.getElementById('pTitle').innerText = `${sn} - ${rn}`;
        document.getElementById('dl').href = url;
        player.play();
        document.getElementById('pBar').classList.remove('hidden-player');
    }

    function toggleP() { player.paused ? player.play() : player.pause(); }

    player.onplay = () => { document.getElementById('pIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; };
    player.onpause = () => { document.getElementById('pIcon').innerHTML = '<path d="M8 5v14l11-7z"/>'; };

    player.ontimeupdate = () => {
        const p = (player.currentTime / player.duration) * 100;
        document.getElementById('pFill').style.width = p + '%';
        document.getElementById('cT').innerText = fmt(player.currentTime);
        document.getElementById('tT').innerText = fmt(player.duration);
    };

    function skip(s) { player.currentTime += s; }
    function setSpd() {
        const s = [1, 1.25, 1.5, 2];
        player.playbackRate = s[(s.indexOf(player.playbackRate) + 1) % s.length];
        document.getElementById('spd').innerText = player.playbackRate + 'x';
    }
    function fmt(s) { return isNaN(s) ? "00:00" : new Date(s * 1000).toISOString().substr(14, 5); }
    function seek(e) { player.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * player.duration; }

    async function loadP() {
        const res = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Cairo&country=Egypt&method=5');
        const d = await res.json();
        pT = d.data.timings;
        document.getElementById('dateH').innerText = `${d.data.date.hijri.day} ${d.data.date.hijri.month.ar} ${d.data.date.hijri.year} هـ`;
        const n = {Fajr:'الفجر', Dhuhr:'الظهر', Asr:'العصر', Maghrib:'المغرب', Isha:'العشاء'};
        document.getElementById('p-grid').innerHTML = Object.entries(n).map(([k,v]) => `<div class="bg-white p-3 rounded-xl shadow-sm text-center"><b>${v}</b><br><span class="text-emerald-900 text-[10px]">${pT[k]}</span></div>`).join('');
    }

    function checkA() {
        if(!pT.Fajr) return;
        const now = new Date();
        const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        
        if(Object.values(pT).includes(cur) && azan.paused && now.getSeconds() < 2) {
            if(!player.paused) player.pause();
            azan.play();
            document.getElementById('azanStatus').classList.remove('hidden');
        }

        const n = {Fajr:'الفجر', Dhuhr:'الظهر', Asr:'العصر', Maghrib:'المغرب', Isha:'العشاء'};
        let m = Infinity, nx = "";
        for(let k in n) {
            const [h, mi] = pT[k].split(':');
            let d = new Date(); d.setHours(h, mi, 0);
            let df = d - now;
            if(df < 0) { d.setDate(d.getDate()+1); df = d - now; }
            if(df < m) { m = df; nx = n[k]; }
        }
        const hr = Math.floor(m/3600000).toString().padStart(2,'0');
        const mn = Math.floor((m%3600000)/60000).toString().padStart(2,'0');
        const sc = Math.floor((m%60000)/1000).toString().padStart(2,'0');
        document.getElementById('timer').innerText = `${hr}:${mn}:${sc}`;
        document.getElementById('nextP').innerText = "موعد أذان " + nx;
    }

    function tab(btn, id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    window.addEventListener('deviceorientation', (e) => {
        let n = e.webkitCompassHeading || (360 - e.alpha);
        document.getElementById('needle').style.transform = `rotate(${-n}deg)`;
    }, true);

    window.addEventListener('click', () => { if(azan.paused) { azan.play(); azan.pause(); } }, { once: true });

    init();
    setInterval(checkA, 1000);
</script>
</body>
</html>